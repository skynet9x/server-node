`use strict`;

const fs = require(`fs-extra`);
const checkDirname = require(`${__dirname}/../helper/checkDirname.js`);
const tmpdir = require(`os`).tmpdir();

function emptySync(_this, dir) {
  if (dir) {
    checkDirname(dir);

    const path = `${_this.dir}/${dir}`;

    fs.emptyDirSync(path);

    if (_this.options.git) {
      _this.git.addSync(`"${path}"`);
      _this.git.commitSync(`"${path}"`, `emptySync: ${dir}`);
    }
  } else {
    if (_this.options.git) {

      //TODO determine a unique id
      const tmpdirSub = `git_${Math.round(Math.random() * 100000)}`;

      fs.copySync(`${_this.dir}/.git`, `${tmpdir}/${tmpdirSub}`);
      fs.emptyDirSync(_this.dir);

      fs.copySync(`${tmpdir}/${tmpdirSub}`, `${_this.dir}/.git`);
      fs.removeSync(`${tmpdir}/${tmpdirSub}`);

      _this.git.addSync(`.`);
      _this.git.commitSync(``, `emptySync: complete storage`);

    } else {
      fs.emptyDirSync(_this.dir);
    }
  }
}

module.exports = emptySync;
