`use strict`;

const fs = require(`fs-extra`);
const checkDirname = require(`${__dirname}/../helper/checkDirname.js`);
const tmpdir = require(`os`).tmpdir();

async function empty(_this, dir) {
  if (dir) {
    checkDirname(dir);

    const path = `${_this.dir}/${dir}`;
    await fs.emptyDir(path);

    if (_this.options.git) {
      await _this.git.add(`"${path}"`);
      await _this.git.commit(`"${path}"`, `empty: ${dir}`);
    }
  } else {
    if (_this.options.git) {

      //TODO determine a unique id
      const tmpdirSub = `git_${Math.round(Math.random() * 100000)}`;
      
      await fs.copy(`${_this.dir}/.git`, `${tmpdir}/${tmpdirSub}`);
      await fs.emptyDir(_this.dir);
      await fs.copy(`${tmpdir}/${tmpdirSub}`, `${_this.dir}/.git`);
      await fs.remove(`${tmpdir}/${tmpdirSub}`);

      await _this.git.add(`.`);
      await _this.git.commit(``, `empty: complete storage`);
    } else {
      await fs.emptyDir(_this.dir);
    }
  }
}

module.exports = empty;
